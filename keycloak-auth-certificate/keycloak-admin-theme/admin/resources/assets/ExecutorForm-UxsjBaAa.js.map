{"version":3,"file":"ExecutorForm-UxsjBaAa.js","sources":["../../../../../../../src/realm-settings/ExecutorForm.tsx"],"sourcesContent":["import type { ConfigPropertyRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/authenticatorConfigInfoRepresentation\";\nimport type ClientProfileRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientProfileRepresentation\";\nimport type ComponentTypeRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/componentTypeRepresentation\";\nimport {\n  HelpItem,\n  KeycloakSelect,\n  SelectVariant,\n  useAlerts,\n  useFetch,\n} from \"@keycloak/keycloak-ui-shared\";\nimport {\n  ActionGroup,\n  AlertVariant,\n  Button,\n  FormGroup,\n  PageSection,\n  SelectOption,\n} from \"@patternfly/react-core\";\nimport { useState } from \"react\";\nimport { Controller, FormProvider, useForm } from \"react-hook-form\";\nimport { useTranslation } from \"react-i18next\";\nimport { Link, useNavigate } from \"react-router-dom\";\nimport { useAdminClient } from \"../admin-client\";\nimport { DynamicComponents } from \"../components/dynamic/DynamicComponents\";\nimport { FormAccess } from \"../components/form/FormAccess\";\nimport { ViewHeader } from \"../components/view-header/ViewHeader\";\nimport { useServerInfo } from \"../context/server-info/ServerInfoProvider\";\nimport { useParams } from \"../utils/useParams\";\nimport { ClientProfileParams, toClientProfile } from \"./routes/ClientProfile\";\nimport type { ExecutorParams } from \"./routes/Executor\";\n\ntype ExecutorForm = {\n  config?: object;\n  executor: string;\n};\n\nconst defaultValues: ExecutorForm = {\n  config: {},\n  executor: \"\",\n};\n\nexport default function ExecutorForm() {\n  const { adminClient } = useAdminClient();\n\n  const { t } = useTranslation();\n  const navigate = useNavigate();\n  const { realm, profileName } = useParams<ClientProfileParams>();\n  const { executorName } = useParams<ExecutorParams>();\n  const { addAlert, addError } = useAlerts();\n  const [selectExecutorTypeOpen, setSelectExecutorTypeOpen] = useState(false);\n  const serverInfo = useServerInfo();\n  const executorTypes =\n    serverInfo.componentTypes?.[\n      \"org.keycloak.services.clientpolicy.executor.ClientPolicyExecutorProvider\"\n    ];\n  const [executors, setExecutors] = useState<ComponentTypeRepresentation[]>([]);\n  const [executorProperties, setExecutorProperties] = useState<\n    ConfigPropertyRepresentation[]\n  >([]);\n  const [globalProfiles, setGlobalProfiles] = useState<\n    ClientProfileRepresentation[]\n  >([]);\n  const [profiles, setProfiles] = useState<ClientProfileRepresentation[]>([]);\n  const form = useForm({ defaultValues });\n  const { control, reset, handleSubmit } = form;\n  const editMode = !!executorName;\n\n  const setupForm = (profiles: ClientProfileRepresentation[]) => {\n    const profile = profiles.find((profile) => profile.name === profileName);\n    const executor = profile?.executors?.find(\n      (executor) => executor.executor === executorName,\n    );\n    if (executor) reset({ config: executor.configuration });\n  };\n\n  useFetch(\n    () =>\n      adminClient.clientPolicies.listProfiles({ includeGlobalProfiles: true }),\n    (profiles) => {\n      setGlobalProfiles(profiles.globalProfiles!);\n      setProfiles(profiles.profiles!);\n\n      setupForm(profiles.profiles!);\n      setupForm(profiles.globalProfiles!);\n    },\n    [],\n  );\n\n  const save = async () => {\n    const formValues = form.getValues();\n    const updatedProfiles = profiles.map((profile) => {\n      if (profile.name !== profileName) {\n        return profile;\n      }\n\n      const executors = (profile.executors ?? []).concat({\n        executor: formValues.executor,\n        configuration: formValues.config || {},\n      });\n\n      if (editMode) {\n        const profileExecutor = profile.executors!.find(\n          (executor) => executor.executor === executorName,\n        );\n        profileExecutor!.configuration = {\n          ...profileExecutor!.configuration,\n          ...formValues.config,\n        };\n      }\n\n      if (editMode) {\n        return profile;\n      }\n      return {\n        ...profile,\n        executors,\n      };\n    });\n    try {\n      await adminClient.clientPolicies.createProfiles({\n        profiles: updatedProfiles,\n        globalProfiles: globalProfiles,\n      });\n      addAlert(\n        editMode ? t(\"updateExecutorSuccess\") : t(\"addExecutorSuccess\"),\n        AlertVariant.success,\n      );\n\n      navigate(toClientProfile({ realm, profileName }));\n    } catch (error) {\n      addError(editMode ? \"updateExecutorError\" : \"addExecutorError\", error);\n    }\n  };\n\n  const globalProfile = globalProfiles.find(\n    (globalProfile) => globalProfile.name === profileName,\n  );\n\n  const profileExecutorType = executorTypes?.find(\n    (executor) => executor.id === executorName,\n  );\n\n  const editedProfileExecutors =\n    profileExecutorType?.properties.map<ConfigPropertyRepresentation>(\n      (property) => {\n        const globalDefaultValues = editMode ? property.defaultValue : \"\";\n        return {\n          ...property,\n          defaultValue: globalDefaultValues,\n        };\n      },\n    );\n\n  return (\n    <>\n      <ViewHeader\n        titleKey={editMode ? executorName : t(\"addExecutor\")}\n        divider\n      />\n      <PageSection variant=\"light\">\n        <FormAccess\n          isHorizontal\n          role=\"manage-realm\"\n          className=\"pf-v5-u-mt-lg\"\n          isReadOnly={!!globalProfile}\n        >\n          <FormGroup\n            label={t(\"executorType\")}\n            fieldId=\"kc-executorType\"\n            labelIcon={\n              executors.length > 0 && executors[0].helpText! !== \"\" ? (\n                <HelpItem\n                  helpText={executors[0].helpText}\n                  fieldLabelId=\"executorTypeHelpText\"\n                />\n              ) : editMode ? (\n                <HelpItem\n                  helpText={profileExecutorType?.helpText}\n                  fieldLabelId=\"executorTypeHelpText\"\n                />\n              ) : undefined\n            }\n          >\n            <Controller\n              name=\"executor\"\n              defaultValue=\"\"\n              control={control}\n              render={({ field }) => (\n                <KeycloakSelect\n                  toggleId=\"kc-executor\"\n                  placeholderText=\"Select an executor\"\n                  onToggle={(isOpen) => setSelectExecutorTypeOpen(isOpen)}\n                  onSelect={(value) => {\n                    reset({ ...defaultValues, executor: value.toString() });\n                    const selectedExecutor = executorTypes?.filter(\n                      (type) => type.id === value,\n                    );\n                    setExecutors(selectedExecutor ?? []);\n                    setExecutorProperties(\n                      selectedExecutor?.[0].properties ?? [],\n                    );\n                    setSelectExecutorTypeOpen(false);\n                  }}\n                  selections={editMode ? executorName : field.value}\n                  variant={SelectVariant.single}\n                  data-testid=\"executorType-select\"\n                  aria-label={t(\"executorType\")}\n                  isOpen={selectExecutorTypeOpen}\n                  maxHeight={580}\n                  isDisabled={editMode}\n                >\n                  {executorTypes?.map((option) => (\n                    <SelectOption\n                      selected={option.id === field.value}\n                      key={option.id}\n                      value={option.id}\n                      description={option.helpText}\n                    >\n                      {option.id}\n                    </SelectOption>\n                  ))}\n                </KeycloakSelect>\n              )}\n            />\n          </FormGroup>\n          <FormProvider {...form}>\n            <DynamicComponents\n              properties={\n                editMode ? editedProfileExecutors! : executorProperties\n              }\n            />\n          </FormProvider>\n          {!globalProfile && (\n            <ActionGroup>\n              <Button\n                variant=\"primary\"\n                onClick={() => handleSubmit(save)()}\n                data-testid=\"addExecutor-saveBtn\"\n              >\n                {editMode ? t(\"save\") : t(\"add\")}\n              </Button>\n              <Button\n                variant=\"link\"\n                component={(props) => (\n                  <Link\n                    {...props}\n                    to={toClientProfile({ realm, profileName })}\n                  />\n                )}\n                data-testid=\"addExecutor-cancelBtn\"\n              >\n                {t(\"cancel\")}\n              </Button>\n            </ActionGroup>\n          )}\n        </FormAccess>\n        {editMode && globalProfile && (\n          <div className=\"kc-backToProfile\">\n            <Button\n              component={(props) => (\n                <Link {...props} to={toClientProfile({ realm, profileName })} />\n              )}\n              variant=\"primary\"\n            >\n              {t(\"back\")}\n            </Button>\n          </div>\n        )}\n      </PageSection>\n    </>\n  );\n}\n"],"names":["defaultValues","ExecutorForm","adminClient","useAdminClient","t","useTranslation","navigate","useNavigate","realm","profileName","useParams","executorName","addAlert","addError","useAlerts","selectExecutorTypeOpen","setSelectExecutorTypeOpen","useState","executorTypes","useServerInfo","executors","setExecutors","executorProperties","setExecutorProperties","globalProfiles","setGlobalProfiles","profiles","setProfiles","form","useForm","control","reset","handleSubmit","editMode","setupForm","executor","profile","useFetch","save","formValues","updatedProfiles","profileExecutor","AlertVariant","toClientProfile","error","globalProfile","profileExecutorType","editedProfileExecutors","property","globalDefaultValues","jsxs","Fragment","jsx","ViewHeader","PageSection","FormAccess","FormGroup","HelpItem","Controller","field","KeycloakSelect","isOpen","value","selectedExecutor","type","SelectVariant","option","SelectOption","FormProvider","DynamicComponents","ActionGroup","Button","props","Link"],"mappings":"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"}