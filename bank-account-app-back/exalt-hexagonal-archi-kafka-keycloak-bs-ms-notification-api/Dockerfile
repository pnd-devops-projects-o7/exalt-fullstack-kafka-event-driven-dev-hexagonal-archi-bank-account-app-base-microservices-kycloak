FROM maven:3.9.8-eclipse-temurin-21-alpine AS builder
ARG NOTIFICATION_API_APP_NAME
ARG MAIL_SENDER_GMAIL_SERVER_HOST
ARG MAIL_SENDER_GMAIL_SERVER_PORT
ARG MAIL_SENDER_GMAIL_SERVER_USERNAME
ARG MAIL_SENDER_GMAIL_SERVER_PASSWORD
ARG NOTIFICATION_API_SERVER_PORT
ARG SERVICE_REGISTRY_API_APP_NAME
ARG SERVICE_REGISTRY_API_SERVER_PORT
ARG MAIL_SERVER_HOSTNAME
ARG MAIL_SERVER_HOST_PORT
ARG MAIL_SERVER_USERNAME
ARG MAIL_SERVER_PASSWORD
ARG MAIL_SENDER_PROTOCOL
ARG CUSTOMER_TOPIC_NAME
ARG ACCOUNT_TOPIC_NAME1
ARG ACCOUNT_TOPIC_NAME2
ARG OPERATION_TOPIC1_NAME
ARG OPERATION_TOPIC2_NAME

ENV NOTIFICATION_API_APP_NAME=${NOTIFICATION_API_APP_NAME}
ENV MAIL_SENDER_GMAIL_SERVER_HOST=${MAIL_SENDER_GMAIL_SERVER_HOST}
ENV MAIL_SENDER_GMAIL_SERVER_PORT=${MAIL_SENDER_GMAIL_SERVER_PORT}
ENV MAIL_SENDER_GMAIL_SERVER_USERNAME=${MAIL_SENDER_GMAIL_SERVER_USERNAME}
ENV MAIL_SENDER_GMAIL_SERVER_PASSWORD=${MAIL_SENDER_GMAIL_SERVER_PASSWORD}
ENV NOTIFICATION_API_SERVER_PORT=${NOTIFICATION_API_SERVER_PORT}
ENV SERVICE_REGISTRY_API_APP_NAME=${SERVICE_REGISTRY_API_APP_NAME}
ENV SERVICE_REGISTRY_API_SERVER_PORT=${SERVICE_REGISTRY_API_SERVER_PORT}
ENV MAIL_SERVER_HOSTNAME=${MAIL_SERVER_HOSTNAME}
ENV MAIL_SERVER_HOST_PORT=${MAIL_SERVER_HOST_PORT}
ENV MAIL_SERVER_USERNAME=${MAIL_SERVER_USERNAME}
ENV MAIL_SERVER_PASSWORD=${MAIL_SERVER_PASSWORD}
ENV MAIL_SENDER_PROTOCOL=${MAIL_SENDER_PROTOCOL}
ENV CUSTOMER_TOPIC_NAME=${CUSTOMER_TOPIC_NAME}
ENV ACCOUNT_TOPIC_NAME1=${ACCOUNT_TOPIC_NAME1}
ENV ACCOUNT_TOPIC_NAME2=${ACCOUNT_TOPIC_NAME2}
ENV OPERATION_TOPIC1_NAME=${OPERATION_TOPIC1_NAME}
ENV OPERATION_TOPIC2_NAME=${OPERATION_TOPIC2_NAME}

WORKDIR /build/
COPY pom.xml /build/
COPY src /build/src
RUN mvn package -DskipTest
WORKDIR /build/target/
RUN java -Djarmode=layertools -jar exalt-hexagonal-archi-kafka-keycloak-bs-ms-notification-api.jar extract

FROM maven:3.9.8-eclipse-temurin-21-alpine AS final
COPY --from=builder /build/target/dependencies/ ./
COPY --from=builder /build/target/spring-boot-loader/ ./
COPY --from=builder /build/target/snapshot-dependencies/ ./
COPY --from=builder /build/target/application/ ./

EXPOSE ${NOTIFICATION_API_SERVER_PORT}

ENTRYPOINT ["java", "org.springframework.boot.loader.launch.JarLauncher"]